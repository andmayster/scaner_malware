import string
import sqlite3
import requests
import os
from oletools.olevba import VBA_Parser, TYPE_OLE, TYPE_OpenXML, TYPE_Word2003_XML, TYPE_MHTML
import json
from oletools.thirdparty.tablestream import tablestream
from sqlite3 import Error
import datetime
""" 
Константы которые устанавливаются, чтобы понимать, какой порог опасности мы можем допустить.
Hex строки имеют гораздо больший порог нежели остальные, поскольку заголовки в модулях схожи
с хексовым форматом.

"""
AUTOEXEC = 1
SUSPICIOUS = 5
HEX_STR = 7
IOS_STR = 1
BASE64_STR = 5
VBA_STR = 1
DRIDEX_STR = 1


def create_connection(path):
    connection = None
    try:
        connection = sqlite3.connect(path)
        print("Connection to SQLite DB successful")
    except Error as e:
        print(f"The error '{e}' occurred")

    return connection


def execute_query(connection, query, value):
    cursor = connection.cursor()
    try:
        cursor.execute(query, value)
        connection.commit()
        print("Query executed successfully")
    except Error as e:
        print(f"The error '{e}' occurred")


def execute_query_one(connection, query):
    cursor = connection.cursor()
    try:
        cursor.execute(query)
        connection.commit()
        print("Query executed successfully")
    except Error as e:
        print(f"The error '{e}' occurred")


connection = create_connection('db.sqlite3')


def main():

    directory = 'media/'


    cleardata = "Delete From scaner_details"
    execute_query_one(connection, cleardata)

    dir = os.listdir(directory)
    lst = []

    for i in dir:
        if i.endswith('.xlsx') or i.endswith('.xlsm') or i.endswith('xls') or i.endswith('doc') or i.endswith('docx'):
            lst.append(directory + i)


    for i in lst:
        vbapars = VBA_Parser(i)
        if vbapars.detect_vba_macros():
            print(i.split('/')[-1] + ' vba macros found')
            scaner(vbapars, True)
        elif not vbapars.detect_vba_macros():
            print(i.split('/')[-1] + ' VBA macros not found')
            scaner(vbapars, False)
        else:
            print(i.split('/')[-1] + ' smth went wrong!')


def scaner(vbapars, statusfile):

    now = datetime.datetime.now()  # current date and time
    time = now.strftime("%Y-%m-%d %H:%M")

    vbapars = vbapars
    name_path = vbapars.filename
    new_path = name_path.split('/')[-1]

    for (filename, stream_path, vba_filename, vba_code) in vbapars.extract_macros():
        result = vbapars.analyze_macros(show_decoded_strings=True)
        if vbapars.nb_autoexec >= AUTOEXEC or vbapars.nb_suspicious >= SUSPICIOUS or vbapars.nb_hexstrings >= HEX_STR \
                or vbapars.nb_iocs >= IOS_STR or vbapars.nb_base64strings >= BASE64_STR or \
                vbapars.nb_dridexstrings >= DRIDEX_STR or vbapars.nb_vbastrings >= VBA_STR:
            path_dir = 'Logs/' + new_path
            if not os.path.isdir(path_dir):
                os.makedirs(path_dir)
            name_file = vba_filename
            output = open('Logs/' + new_path + '/' + name_file + ".txt", "w")
            output.write(vba_code)
            output.close()


    autoexec = '\nAutoExec keywords: ' + str(vbapars.nb_autoexec) + '\n'
    statusfile = statusfile
    hex = 'Hex obfuscated strings: ' + str(vbapars.nb_hexstrings) + '\n'
    suspicious = 'Suspicious keywords: ' + str(vbapars.nb_suspicious) + '\n'
    iocs = 'IOCs: ' + str(vbapars.nb_iocs) + '\n'
    base64 = 'Base64: ' + str(vbapars.nb_base64strings) + '\n'
    dridex = 'Dridex obfuscated strings: ' + str(vbapars.nb_dridexstrings) + '\n'
    vba = 'VBA obfuscated strings: ' + str(vbapars.nb_vbastrings) + '\n'

    value = [new_path, statusfile, autoexec, hex, suspicious, iocs, base64, dridex, vba, time]
    add = "Insert INTO scaner_results (name, status_file, autoexec, hex_obfuscated," \
          " suspicious, iocs, base64, dridex_obfuscated, vba_obfuscated,  datetime) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?);"
    execute_query(connection, add, value)

    if statusfile is True:
        for kw_type, keyword, description in result:
            details =[str(kw_type), str(keyword), str(description)]
            adddet = "Insert INTO scaner_details (kwtype, keyword, descr) VALUES (?, ?, ?);"
            execute_query(connection, adddet, details)


    os.remove('media/' + new_path)
    vbapars.close()


if __name__ == '__main__':
    main()