Attribute VB_Name = "Load"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True
Attribute VB_Control = "CommandLoad, 1, 0, MSForms, CommandButton"
'Dim Holidays() As String
'Dim keyHoliday As Boolean
Public FSO, folder
Dim sel_zag()
Dim sel_arr()
Public introw As Long
Public introwint As Long
Public introwser As Long

Public introwprt As Long
Public interr As Long
Public columnInt
Public columnSer
Public numerr As Integer
Public erri As Integer
Public errS As Integer



Private Sub CommandLoad_Click()
        
    MsgBox "Для підвищення швидкості обробки будуть закриті всі вікна EXCEL, окрім активного вікна", vbOKOnly, "Увага"
    Dim Book As Workbook
    For Each Book In Application.Workbooks
        If Book.Name <> ThisWorkbook.Name Then
            Book.Close savechanges:=True
        End If
    Next Book
    Application.ThisWorkbook.Activate
    

    Load.Range("B8:K1000").ClearContents
    Load.Range("B8:K1000").Borders.Color = vbWhite
    Err.Range("B3:E5000").ClearContents
    Err.Range("B3:E5000").Borders.Color = vbWhite
    Inter.Range("C7:BI1000").ClearContents
    Ser.Range("B5:AM1000").ClearContents
    Prt.Range("C5:E1000").ClearContents

    
    introwint = 7
    introwprt = 5
    introwser = 5
    interr = 3
    introw = 8 'рядок з якого вводяться дані про файли

    
    
    
    Set FSO = CreateObject("Scripting.FileSystemObject")
    Set folder = FSO.GetFolder(ThisWorkbook.Path)
    For Each file In folder.Files
    Load.Range("B" & introw, "K" & introw).Borders.Color = vbBlack
    
    Application.EnableEvents = False
    Application.ScreenUpdating = False
        tmp_f = Split(file.Name, ".")
        Load.Cells(introw, 2) = file.Name
        If UBound(tmp_f) > 0 And (Left(tmp_f(0), 3) = "INT" Or Left(tmp_f(0), 3) = "SER" Or Left(tmp_f(0), 3) = "PRT") Then
            tmp_f = Split(tmp_f(0), "_")
         Load.Cells(introw, 3) = tmp_f(1)
            Load.Cells(introw, 5) = tmp_f(2)
            
           ' Load.Cells(introw, 7) = CStr(tmp_f(2))
            If UBound(tmp_f) = 3 Then Load.Cells(introw, 7) = CStr(tmp_f(3)) Else Load.Cells(introw, 7) = ""
            Application.Workbooks.Open ThisWorkbook.Path & "\" & file.Name
            If tmp_f(0) = "INT" Then
                If dhSheetExist("Registration") Then
                    Application.Worksheets("Registration").Select
                    If ActiveSheet.FilterMode Then AFilterCount = Worksheets("Registration").AutoFilter.Range.Rows.Count 'Общее количество строк в автофильтре
                    'Свойство FilterMode. Допустимые значения: True (если на рабочем листе имеются отфильтрованные данные со скрытыми строками), False (в противном случае)
                    Inter.Cells(introwint, 3) = file.Name
                    Call INTopen(file.Name)
                    introw = introw + 1
                    introwint = introwint + 1
                    Application.Workbooks(file.Name).Close savechanges:=False
                Else
                    Load.Cells(introw, 9) = "Файл не було завантажено. Не знайдений лист ""Registration"""
                    Load.Cells(introw, 10) = "ПОМИЛКА!"
                    Application.ThisWorkbook.Activate
                    Application.Workbooks(file.Name).Close savechanges:=False
                    introw = introw + 1
                    GoTo iii
                End If
            ElseIf tmp_f(0) = "SER" Then
                If dhSheetExist("Registration") Then
                    Application.Worksheets("Registration").Select
                    If ActiveSheet.FilterMode Then AFilterCount = Worksheets("Registration").AutoFilter.Range.Rows.Count 'Общее количество строк в автофильтре
                    'Свойство FilterMode. Допустимые значения: True (если на рабочем листе имеются отфильтрованные данные со скрытыми строками), False (в противном случае)
'''                    Inter.Cells(introwint, 2) = file.Name
                    Call SERopen(file.Name)
                    introw = introw + 1
                    introwser = introwser + 1
                    Application.Workbooks(file.Name).Close savechanges:=False
                Else
                    Load.Cells(introw, 9) = "Файл не було завантажено. Не знайдений лист ""Registration"""
                    Load.Cells(introw, 10) = "ПОМИЛКА!"
                    Application.ThisWorkbook.Activate
                    Application.Workbooks(file.Name).Close savechanges:=False
                    introw = introw + 1
                    GoTo iii
                End If
                  ElseIf tmp_f(0) = "PRT" Then
                If dhSheetExist("Registration") Then
                    Application.Worksheets("Registration").Select
                    If ActiveSheet.FilterMode Then AFilterCount = Worksheets("Registration").AutoFilter.Range.Rows.Count 'Общее количество строк в автофильтре
                    'Свойство FilterMode. Допустимые значения: True (если на рабочем листе имеются отфильтрованные данные со скрытыми строками), False (в противном случае)
'''                    Inter.Cells(introwint, 2) = file.Name
                    Call PRTopen(file.Name)
                    introw = introw + 1
                    introwpre = introwpre + 1
                    Application.Workbooks(file.Name).Close savechanges:=False
                Else
                    Load.Cells(introw, 9) = "Файл не було завантажено. Не знайдений лист ""Registration"""
                    Load.Cells(introw, 10) = "ПОМИЛКА!"
                    Application.ThisWorkbook.Activate
                    Application.Workbooks(file.Name).Close savechanges:=False
                    introw = introw + 1
                    GoTo iii
                End If
            
                
            End If
            
            
        Else
            introw = introw + 1
            GoTo iii
        End If
iii:
Application.EnableEvents = True
Application.ScreenUpdating = True
    Next file
Err.Range("B3:E" & interr).Borders.Color = vbBlack
    
    
End Sub
Sub SERopen(fileName)
    Dim arrInt()
    Dim results()
    
    Set holidays = CreateObject("Scripting.Dictionary")
    Set holidaysP = CreateObject("Scripting.Dictionary")
    Set holidaysN = CreateObject("Scripting.Dictionary")
    Call FirstHolidays(holidays, Application.Worksheets("Registration").Range("year").Value)
    Call FirstHolidays(holidaysP, Val(Application.Worksheets("Registration").Range("year").Value) - 1)
    Call FirstHolidays(holidaysN, Val(Application.Worksheets("Registration").Range("year").Value) + 1)
    
    sel_arr = Application.Worksheets("Holidays").Range("A9:B" & Application.Worksheets("Holidays").UsedRange.Rows.Count + 1).Value
    For i = 1 To UBound(sel_arr)
        If Val(sel_arr(i, 1)) <> 0 Then
            If IsDate(sel_arr(i, 1)) Then
                sel_arr(i, 1) = Format(sel_arr(i, 1), "dd.mm.yyyy")
                If Val(Year(sel_arr(i, 1))) = Val(Application.Worksheets("Registration").Range("year").Value) Then
                    If Not holidays.exists(CDate(sel_arr(i, 1))) Then holidays.Add CDate(sel_arr(i, 1)), Month(CDate(sel_arr(i, 1)))
                ElseIf Val(Year(sel_arr(i, 1))) = Val(Application.Worksheets("Registration").Range("year").Value) - 1 Then
                    If Not holidaysP.exists(CDate(sel_arr(i, 1))) Then holidays.Add CDate(sel_arr(i, 1)), Month(CDate(sel_arr(i, 1)))
                ElseIf Val(Year(sel_arr(i, 1))) = Val(Application.Worksheets("Registration").Range("year").Value) + 1 Then
                    If Not holidaysN.exists(CDate(sel_arr(i, 1))) Then holidays.Add CDate(sel_arr(i, 1)), Month(CDate(sel_arr(i, 1)))
                End If
            End If
        End If
        If Val(sel_arr(i, 2)) <> 0 Then
            If IsDate(sel_arr(i, 2)) Then
                sel_arr(i, 2) = Format(sel_arr(i, 2), "dd.mm.yyyy")
                If Val(Year(sel_arr(i, 2))) = Val(Application.Worksheets("Registration").Range("year").Value) Then
                    If holidays.exists(CDate(sel_arr(i, 2))) Then holidays.Remove CDate(sel_arr(i, 2))
                ElseIf Val(Year(sel_arr(i, 2))) = Val(Application.Worksheets("Registration").Range("year").Value) - 1 Then
                    If holidaysP.exists(CDate(sel_arr(i, 2))) Then holidays.Remove CDate(sel_arr(i, 2))
                ElseIf Val(Year(sel_arr(i, 2))) = Val(Application.Worksheets("Registration").Range("year").Value) + 1 Then
                    If holidaysN.exists(CDate(sel_arr(i, 2))) Then holidays.Remove CDate(sel_arr(i, 2))
                End If
            End If
        End If
    Next i
    
    sel_arr = Application.Worksheets("Registration").Range("C15:V" & Application.Worksheets("Registration").UsedRange.Rows.Count).Value
    arr_columnInt = Array("Num", "Skod", "Source", "CName", "Adr", "Other", "Top", "T1", "T2", "Zk", "Zr", "Dk", "Dr", "ReasZ", "ReasN", "Comm", "Error")
    Call SetColumnName(arrInt, arr_columnInt, Application.Worksheets("Registration").UsedRange.Rows.Count - 15 + 1)
    sel_zag = Application.Worksheets("Registration").Range("C14", "V14").Value
    Load.Cells(introw, 4) = Application.Worksheets("Registration").Range("M7").Value
    Load.Cells(introw, 8) = Application.Worksheets("Registration").Range("H7").Value
    Load.Cells(introw, 6) = Application.Worksheets("Registration").Range("S7").Value
    ReDim results(1 To 36)
    Set columnSer = CreateObject("Scripting.Dictionary")
    Set columnSer = SetColl(arr_columnInt)
    numerr = 0
    

    If sel_zag(1, 1) <> "Num" Then
        Load.Cells(introw, 9) = "Файл не було завантажено. Невірна форма"
        Load.Cells(introw, 10) = "ПОМИЛКА!"
        Exit Sub
    End If
    For j = 1 To UBound(sel_arr, 2)
        If sel_zag(1, j) <> "" Then
            For i = 1 To UBound(sel_arr)
                arrInt(i, columnSer(sel_zag(1, j))) = sel_arr(i, j)
            Next i
        End If
    Next j
    
    If Not IsEmpty(sel_arr) Then
        colS = columnSer("Skod")
        For i = 1 To UBound(arrInt, 1)
            If IsError(arrInt(i, columnSer("T1"))) Then
                arrInt(i, columnSer("T1")) = ""
            Else
                arrInt(i, columnSer("T1")) = Trim(arrInt(i, columnSer("T1")))
                arrInt(i, columnSer("T2")) = Trim(arrInt(i, columnSer("T2")))
                arrInt(i, columnSer("T1")) = Replace(arrInt(i, columnSer("T1")), ",", ".")
                arrInt(i, columnSer("T1")) = Replace(arrInt(i, columnSer("T1")), ";", ":")
                arrInt(i, columnSer("T2")) = Replace(arrInt(i, columnSer("T2")), ",", ".")
                arrInt(i, columnSer("T2")) = Replace(arrInt(i, columnSer("T2")), ";", ":")
            End If
            If Val(arrInt(i, columnSer("Zr"))) <> 0 Then arrInt(i, columnSer("Zr")) = Val(arrInt(i, columnSer("Zr"))) Else arrInt(i, columnSer("Zr")) = ""
            If Val(arrInt(i, columnSer("Zk"))) <> 0 Then arrInt(i, columnSer("Zk")) = Val(arrInt(i, columnSer("Zk"))) Else arrInt(i, columnSer("Zk")) = ""
            If ((IsDate(arrInt(i, columnSer("T1"))) = True) Or (arrInt(i, columnSer("T1")) = "")) And ((IsDate(arrInt(i, columnSer("T2"))) = True) Or (arrInt(i, columnSer("T2")) = "")) Then
                If IsDate(arrInt(i, columnSer("T2"))) Then arrInt(i, columnSer("T2")) = Format(arrInt(i, columnSer("T2")), "dd.mm.yyyy")
                If IsDate(arrInt(i, columnSer("T1"))) Then arrInt(i, columnSer("T1")) = Format(arrInt(i, columnSer("T1")), "dd.mm.yyyy")
                If (arrInt(i, columnSer("T1")) <> "") And (arrInt(i, columnSer("T2")) <> "") Then
                    If IsDate(arrInt(i, columnSer("T2"))) And IsDate(arrInt(i, columnSer("T1"))) Then
                        If arrInt(i, colS) = "S1.2" Or arrInt(i, colS) = "S2" Or arrInt(i, colS) = "S2.1" Then
                            arrInt(i, columnSer("Dk")) = DateDiff("d", arrInt(i, columnSer("T1")), arrInt(i, columnSer("T2"))) - Val(arrInt(i, columnSer("Zk")))
                            If Val(arrInt(i, columnSer("Dk"))) = 0 Then arrInt(i, columnSer("Dk")) = 1
                            If arrInt(i, colS) <> "S2.1" Then arrInt(i, columnSer("Dr")) = ""
                        End If
                        If arrInt(i, colS) = "S1.1" Or Left(arrInt(i, colS), 2) = "S2" Then
                            arrInt(i, columnSer("Dr")) = WorkDateDiff(arrInt(i, columnSer("T1")), arrInt(i, columnSer("T2")), Val(Application.Worksheets("Registration").Range("year").Value)) - Val(arrInt(i, columnSer("Zr")))
                            If Val(arrInt(i, columnSer("Dr"))) = 0 Then arrInt(i, columnSer("Dr")) = 1
                            If arrInt(i, colS) <> "S2.1" Then arrInt(i, columnSer("Dk")) = ""
                        End If
                    End If
                Else
                    arrInt(i, columnSer("Dr")) = ""
                    arrInt(i, columnSer("Dk")) = ""
                End If
            Else
                arrInt(i, columnSer("Dr")) = ""
                arrInt(i, columnSer("Dk")) = ""
            End If
            erri = 0
            Call revisionSER(arrInt, i, erri, fileName)
            If erri = 0 Or erri = 2 Then
                For j = 1 To 9
                    If arrInt(i, columnSer("Skod")) = Ser.Cells(3, 2 + j) Then
                        If arrInt(i, columnSer("ReasN")) = "" Then
                            results(j) = Val(results(j)) + 1
                            If arrInt(i, colS) <> "S3.1" Then
                                results(j + 18) = Val(results(j + 18)) + Val(arrInt(i, columnSer("Dk"))) + Val(arrInt(i, columnSer("Dr")))
                            Else
                                results(j + 18) = Val(results(j + 18)) + Val(arrInt(i, columnSer("Dk")))
                            End If
                            If erri = 2 Then results(j + 27) = Val(results(j + 27)) + 1
                        Else
                            results(j + 9) = Val(results(j + 9)) + 1
                        End If
                    End If
                Next j
            Else
                numerr = numerr + erri
            End If
        Next i
    End If
        Ser.Range("AM" & introwser).Value = numerr
        Ser.Range("B" & introwser).Value = fileName
        If numerr > 0 Then Load.Cells(introw, 9) = "Не враховано " & numerr & " перерв"
        Load.Cells(introw, 10) = "OK"
        Load.Cells(introw, 11) = Application.Worksheets("Registration").Range("W1").Value
        Ser.Range("C" & introwser, "AL" & introwser).Value = results
End Sub

Sub INTopen(fileName)
    Dim arrInt()
    Dim results()
    sel_arr = Application.Worksheets("Registration").Range("C15", "AK" & Application.Worksheets("Registration").UsedRange.Rows.Count).Value
    arr_columnInt = Array("Num", "Source", "IntAdr", "IntNet", "Work", "P1", "P2", "V1", "V2", "V3", "K1", "K2", "K3", "K4", "K5", "K6", "K7", "T1", "T2", "DurGr", "Dur", "P", "Pe", "Pc", "ENS", "ENSe", "ENSc", "Ne", "Nc", "Comm", "Error")
    Call SetColumnName(arrInt, arr_columnInt, Application.Worksheets("Registration").UsedRange.Rows.Count - 15 + 1)
    sel_zag = Application.Worksheets("Registration").Range("C14", "AK14").Value
    Load.Cells(introw, 4) = Application.Worksheets("Registration").Range("W7").Value
    Load.Cells(introw, 8) = Application.Worksheets("Registration").Range("G7").Value
    Load.Cells(introw, 6) = Application.Worksheets("Registration").Range("month").Value
    ReDim results(1 To 87)
    Set columnInt = CreateObject("Scripting.Dictionary")
    Set columnInt = SetColl(arr_columnInt)
    numerr = 0
    
    If sel_zag(1, 1) <> "Num" Then
        Load.Cells(introw, 9) = "Файл не було завантажено. Невірна форма"
        Load.Cells(introw, 10) = "ПОМИЛКА!"
        Exit Sub
    End If
    For j = 1 To UBound(sel_arr, 2)
        If sel_zag(1, j) <> "" Then
            For i = 1 To UBound(sel_arr)
                arrInt(i, columnInt(sel_zag(1, j))) = sel_arr(i, j)
            Next i
        End If
    Next j
    If Not IsEmpty(sel_arr) Then
        For i = 1 To UBound(arrInt, 1)
            If IsError(arrInt(i, columnInt("T1"))) Then
                arrInt(i, columnInt("T1")) = ""
            Else
                arrInt(i, columnInt("T1")) = Trim(arrInt(i, columnInt("T1")))
                arrInt(i, columnInt("T2")) = Trim(arrInt(i, columnInt("T2")))
                arrInt(i, columnInt("T1")) = Replace(arrInt(i, columnInt("T1")), ",", ".")
                arrInt(i, columnInt("T1")) = Replace(arrInt(i, columnInt("T1")), ";", ":")
                arrInt(i, columnInt("T2")) = Replace(arrInt(i, columnInt("T2")), ",", ".")
                arrInt(i, columnInt("T2")) = Replace(arrInt(i, columnInt("T2")), ";", ":")
            End If
            
            If ((IsDate(arrInt(i, columnInt("T1"))) = True) Or (arrInt(i, columnInt("T1")) = "")) And ((IsDate(arrInt(i, columnInt("T2"))) = True) Or (arrInt(i, columnInt("T2")) = "")) Then
                If IsDate(arrInt(i, columnInt("T2"))) Then arrInt(i, columnInt("T2")) = Format(arrInt(i, columnInt("T2")), "dd.mm.yyyy hh:mm")
                If IsDate(arrInt(i, columnInt("T1"))) Then arrInt(i, columnInt("T1")) = Format(arrInt(i, columnInt("T1")), "dd.mm.yyyy hh:mm")
                If (arrInt(i, columnInt("T1")) <> "") And (arrInt(i, columnInt("T2")) <> "") Then
                    If IsDate(arrInt(i, columnInt("T2"))) And IsDate(arrInt(i, columnInt("T1"))) Then
                        arrInt(i, columnInt("Dur")) = DateDiff("n", arrInt(i, columnInt("T1")), arrInt(i, columnInt("T2"))) - Val(arrInt(i, columnInt("DurGr")))
                    End If
                Else
                    arrInt(i, columnInt("Dur")) = ""
                End If
            Else
                arrInt(i, columnInt("Dur")) = ""
            End If
            
            arrInt(i, columnInt("Pe")) = Replace(arrInt(i, columnInt("Pe")), ".", ",")
            arrInt(i, columnInt("Pc")) = Replace(arrInt(i, columnInt("Pc")), ".", ",")

            If arrInt(i, columnInt("Pe")) <> "" Or arrInt(i, columnInt("Pc")) <> "" Then
                If arrInt(i, columnInt("Pe")) <> "" And arrInt(i, columnInt("Pc")) <> "" Then
                    arrInt(i, columnInt("P")) = CDbl(arrInt(i, columnInt("Pe"))) + CDbl(arrInt(i, columnInt("Pc")))
                    If arrInt(i, columnInt("Dur")) <> "" Then
                        arrInt(i, columnInt("ENS")) = arrInt(i, columnInt("P")) * arrInt(i, columnInt("Dur")) / 60
                        arrInt(i, columnInt("ENSe")) = arrInt(i, columnInt("Pe")) * arrInt(i, columnInt("Dur")) / 60
                        arrInt(i, columnInt("ENSc")) = arrInt(i, columnInt("Pc")) * arrInt(i, columnInt("Dur")) / 60
                    End If
                ElseIf arrInt(i, columnInt("Pe")) <> "" Then
                    arrInt(i, columnInt("P")) = CDbl(arrInt(i, columnInt("Pe")))
                    If arrInt(i, columnInt("Dur")) <> "" Then
                        arrInt(i, columnInt("ENS")) = arrInt(i, columnInt("P")) * arrInt(i, columnInt("Dur")) / 60
                        arrInt(i, columnInt("ENSe")) = arrInt(i, columnInt("Pe")) * arrInt(i, columnInt("Dur")) / 60
                    End If
                Else
                    arrInt(i, columnInt("P")) = CDbl(arrInt(i, columnInt("Pc")))
                    If arrInt(i, columnInt("Dur")) <> "" Then
                        arrInt(i, columnInt("ENS")) = arrInt(i, columnInt("P")) * arrInt(i, columnInt("Dur")) / 60
                        arrInt(i, columnInt("ENSc")) = arrInt(i, columnInt("Pc")) * arrInt(i, columnInt("Dur")) / 60
                    End If
                End If
            Else
                arrInt(i, columnInt("P")) = ""
            End If
            
            
            erri = 0
            Call revision(arrInt, i, erri, fileName)
            If erri = 0 Then
                jj = 0

                For j = 1 To 7
                    If arrInt(i, columnInt("K1") + j - 1) <> "" Then
                        If arrInt(i, columnInt("ENS")) <> "" Then
                            If arrInt(i, columnInt("P1")) <> "" And arrInt(i, columnInt("V1")) <> "" Then jj = 1
                            If arrInt(i, columnInt("P1")) <> "" And arrInt(i, columnInt("V2")) <> "" Then jj = 2
                            If arrInt(i, columnInt("P1")) <> "" And arrInt(i, columnInt("V3")) <> "" Then jj = 3
                            If arrInt(i, columnInt("P2")) <> "" And arrInt(i, columnInt("V1")) <> "" Then jj = 4
                            If arrInt(i, columnInt("P2")) <> "" And arrInt(i, columnInt("V2")) <> "" Then jj = 5
                            If arrInt(i, columnInt("P2")) <> "" And arrInt(i, columnInt("V3")) <> "" Then jj = 6
                            results(j + (jj - 1) * 14) = CDbl(results(j + (jj - 1) * 14)) + CDbl(arrInt(i, columnInt("ENS")))
                            results(j + 7 + (jj - 1) * 14) = Val(results(j + 7 + (jj - 1) * 14)) + 1
                            If j = 7 Then
                                If arrInt(i, columnInt("Dur")) > 360 And arrInt(i, columnInt("V2")) <> "" And arrInt(i, columnInt("V3")) <> "" Then
                                    results(85) = Val(results(85)) + 1
                                    results(86) = Val(results(86)) + Val(arrInt(i, columnInt("Dur")))
                                End If
                            End If
                        End If
                    End If
                Next j
            Else
                numerr = numerr + erri
            End If
        Next i
    End If
        Inter.Range("CJ" & introwint).Value = numerr
        Inter.Range("B" & introwint).Value = fileName
        If numerr > 0 Then Load.Cells(introw, 9) = "Не враховано " & numerr & " перерв"
        Load.Cells(introw, 10) = "OK"
        Load.Cells(introw, 11) = Application.Worksheets("Registration").Range("AM1").Value
        ThisWorkbook.Worksheets("Interrupt").Range("C" & introwint, "CK" & introwint).Value = results
   
    
End Sub


Public Sub revision(sel_arr, i, erri, fileName) 'для arrE diff=3, diff1 =

    Dim notdate As Boolean
    
     sel_arr(i, cError) = ""
     cT1 = columnInt("T1")
     cT2 = columnInt("T2")
    If Val(Application.Worksheets("Registration").Range("month").Value) = 0 Then mon = Val(Application.Worksheets("Data").Range("monnum").Cells(Application.Worksheets("Data").Range("monlist").Find(Application.Worksheets("Registration").Range("month")).Row - 3, 1).Value)


    If sel_arr(i, columnInt("IntAdr")) <> "" And sel_arr(i, cT1) = "" Then
        cError = "Не вказано дату та час початку перерви"
        erri = 1
        GoTo zzz
    End If
    
    If sel_arr(i, columnInt("IntAdr")) = "" And sel_arr(i, cT1) <> "" Then
        cError = "Не вказано адресу місця пошкодження"
        erri = 1
        GoTo zzz
    End If
        
    If (IsDate(sel_arr(i, cT1)) = False) And sel_arr(i, cT1) <> "" Then
        cError = "Невірно вказано дату та час початку перерви"
        erri = 1
        GoTo zzz
    End If
    
    If sel_arr(i, cT1) <> "" Then
        If (IsDate(sel_arr(i, cT1)) = True) Then
            If Val(Application.Worksheets("Registration").Range("check").Value) > 0 Then
                numkv = (Val(Month(sel_arr(i, cT1))) + 2) \ 3
                If (numkv <> Val(Application.Worksheets("Registration").Range("month").Value) Or Year(sel_arr(i, cT1)) <> Val(Application.Worksheets("Registration").Range("Year").Value)) Then
                    cError = "Невірно вказано місяць або рік початку перерви"
                    erri = 1
                    GoTo zzz
                 ElseIf sel_arr(i, cT2) = "" Then
                    cError = "Не вказано дату та час кінця перерви"
                    erri = 1
                    GoTo zzz
                End If
            Else
                If Year(sel_arr(i, cT1)) <> Val(Application.Worksheets("Registration").Range("Year").Value) Then
                    cError = "Невірно вказано рік початку перерви"
                    erri = 1
                    GoTo zzz
                 ElseIf sel_arr(i, cT2) = "" Then
                    cError = "Не вказано дату та час кінця перерви"
                    erri = 1
                    GoTo zzz
                End If
            End If
        End If
    End If
    
    
    If Not IsDate(sel_arr(i, cT2)) And sel_arr(i, cT2) <> "" Then
        cError = "Невірно вказано дату та час кінця перерви"
        erri = 1
        GoTo zzz
    End If
    
     If sel_arr(i, columnInt("IntAdr")) <> "" Or sel_arr(i, cT1) <> "" Then
        If sel_arr(i, columnInt("K1")) = "" And sel_arr(i, columnInt("K2")) = "" And sel_arr(i, columnInt("K3")) = "" And sel_arr(i, columnInt("K4")) = "" And sel_arr(i, columnInt("K5")) = "" And sel_arr(i, columnInt("K6")) = "" And sel_arr(i, columnInt("K7")) = "" Then
            cError = "Не вибрано значення ""класифікація перерв в електропостачанні"" (стовпчики 10-16)"
            erri = 1
            GoTo zzz
         End If
     End If
     
     If sel_arr(i, columnInt("IntAdr")) <> "" Or sel_arr(i, cT1) <> "" Then
        If sel_arr(i, columnInt("P1")) = "" And sel_arr(i, columnInt("P2")) = "" Then
            cError = "Не вибрано значення ""період"" (стовпчики 6-7)"
            erri = 1
            GoTo zzz
         End If
     End If
     
    If sel_arr(i, columnInt("IntAdr")) <> "" Or sel_arr(i, cT1) <> "" Then
        If sel_arr(i, columnInt("V1")) = "" And sel_arr(i, columnInt("V2")) = "" And sel_arr(i, columnInt("V3")) = "" Then
            cError = "Не вибрано значення ""вид діяльності"" (стовпчики 8-9)"
            erri = 1
            GoTo zzz
         End If
     End If
     


     If (sel_arr(i, columnInt("Ne")) = "" Or sel_arr(i, columnInt("Ne")) = 0 Or Not IsNumeric(sel_arr(i, columnInt("Ne")))) And (sel_arr(i, columnInt("Nc")) = "" Or sel_arr(i, columnInt("Nc")) = 0 Or Not IsNumeric(sel_arr(i, columnInt("Nc")))) And (sel_arr(i, columnInt("IntAdr")) <> "" Or sel_arr(i, cT1) <> "") Then
        cError = "Не вказано кількість відключених споживачів"
        erri = 1
        GoTo zzz
     End If
     If (sel_arr(i, columnInt("Pe")) = "" Or sel_arr(i, columnInt("Pe")) = 0 Or Not IsNumeric(sel_arr(i, columnInt("Pe")))) And (sel_arr(i, columnInt("Pc")) = "" Or sel_arr(i, columnInt("Pc")) = 0 Or Not IsNumeric(sel_arr(i, columnInt("Pc")))) And (sel_arr(i, columnInt("IntAdr")) <> "" Or sel_arr(i, cT1) <> "") Then
        cError = "Не вказане від’єднане навантаження"
        erri = 1
        GoTo zzz
     End If


    
     If IsDate(sel_arr(i, cT1)) And IsDate(sel_arr(i, cT2)) Then
         diff = DateDiff("n", sel_arr(i, cT1), sel_arr(i, cT2)) - Val(sel_arr(i, columnInt("DurGr")))
         If diff < 0 Then
            cError = "Від'ємна тривалість перерви"
            erri = 1
            GoTo zzz
        End If
     ElseIf (sel_arr(i, cT1) = "") And IsDate(sel_arr(i, cT2)) Then
        cError = "Не вказано дату та час початку перерви"
        erri = 1
        GoTo zzz
     End If
zzz:
    If erri = 1 Then
        Err.Cells(interr, 2) = fileName
        Err.Cells(interr, 3) = Application.Worksheets("Registration").Range("year").Value
        Err.Cells(interr, 4) = i + 14
        Err.Cells(interr, 5) = cError
        interr = interr + 1
    End If

End Sub
Function NVal(Target)
    Target = Replace(Target, ",", ".")
    NVal = Val(Target)
End Function

Function dhSheetExist(strSheetName As String) As Boolean
    'Dim objSheet As Object
    On Error GoTo HandleError
    'objSheet = ActiveWorkbook.Sheets
    For Each it In ActiveWorkbook.Sheets
        If strSheetName = it.Name Then dhSheetExist = True: Exit Function
    Next it
HandleError:
    dhSheetExist = False
End Function


Public Sub revisionSER(sel_arr, i, erri, fileName) 'для arrE diff=3, diff1 =

    Dim notdate As Boolean
    

'3074     If Not IsMissing(eError) Then eError = ""
    
'     colErr = columnInt("Error")
     colKodServ = columnSer("Skod")
     sel_arr(i, colErr) = ""
     colT1 = columnSer("T1")
     colT2 = columnSer("T2")
    If Val(Application.Worksheets("Registration").Range("month").Value) = 0 Then mon = Val(Application.Worksheets("Data").Range("monnum").Cells(Application.Worksheets("Data").Range("monlist").Find(Application.Worksheets("Registration").Range("month")).Row - 3, 1).Value)
    yea = Application.Worksheets("Registration").Range("year").Value
    

    
    If (IsDate(sel_arr(i, colT1)) = False) And sel_arr(i, colT1) <> "" Then
        cError = "Невірно вказано дату початку надання послуги"
        erri = 1
        GoTo zzz
    ElseIf IsDate(sel_arr(i, colT1)) Then
        If Year(sel_arr(i, colT1)) < Val(yea) - 2 Or Year(sel_arr(i, colT1)) > Val(yea) Then
            cError = "Невірно вказано рік дати початку надання послуги. Рік дати початку не може бути раніше ніж - " & Val(yea) - 2 & ", та пізніше ніж  - " & yea
            erri = 1
            GoTo zzz
        End If
    End If
    
    If (IsDate(sel_arr(i, colT2)) = False) And sel_arr(i, colT2) <> "" Then
'        sel_arr(i, colErr) = IIf(sel_arr(i, colErr) <> "", sel_arr(i, colErr) & Chr(10) & "Невірно вказано дату кінця надання послуги", "Невірно вказано дату кінця надання послуги")
        cError = "Невірно вказано дату кінця надання послуги"
        erri = 1
        GoTo zzz
    ElseIf IsDate(sel_arr(i, colT2)) Then
        If Year(sel_arr(i, colT2)) < Val(yea) Or Year(sel_arr(i, colT2)) > Val(yea) + 2 Then
            cError = "Невірно вказано рік дати кінця надання послуги. Рік дати кінця не може бути раніше ніж - " & Val(yea) & ", та пізніше ніж  - " & Val(yea) + 2
            erri = 1
            GoTo zzz
        End If
    End If
    
    If IsDate(sel_arr(i, colT1)) And IsDate(sel_arr(i, colT2)) Then
        If (DateDiff("d", sel_arr(i, colT1), sel_arr(i, colT2)) - Val(sel_arr(i, columnSer("Zk"))) < 0) Then
            cError = "Дата завершення раніше за дату початку"
            erri = 1
            GoTo zzz
        Else
            If sel_arr(i, columnSer("Skod")) = "S3.1" Then
                If Val(sel_arr(i, columnSer("Zk"))) < Val(sel_arr(i, columnSer("Zr"))) Then
                    cError = "Тривалість надання послуги в робочих днях вища за тривалість надання послуги в календарних днях"
                    erri = 1
                    GoTo zzz
                End If
            End If
        End If
    If sel_arr(i, columnSer("Dr")) < 0 Then
        cError = "Відємна тривалість, перевірте робочі дні"
        erri = 1
        GoTo zzz
    End If
    ElseIf (sel_arr(i, colT1) = "") And IsDate(sel_arr(i, colT2)) Then
        cError = "Не зазначено дату початку надання послуги"
        erri = 1
        GoTo zzz
    End If

    If (sel_arr(i, columnSer("Skod")) = "" And sel_arr(i, colT1) <> "") Then
        cError = "Не вибрано значення ""Код послуги"" (стовпчик 2)"
        erri = 1
        GoTo zzz
    End If

        setUncl = ""
        
            notErr = False
            If sel_arr(i, colErr) = "" Then notErr = True
            If sel_arr(i, colKodServ) <> "" And notErr Then
                If ((IsDate(sel_arr(i, colT1)) = True) Or (sel_arr(i, colT1) = "")) And ((IsDate(sel_arr(i, colT2)) = True) Or (sel_arr(i, colT2) = "")) Then
                    If (sel_arr(i, colT1) <> "") And (sel_arr(i, colT2) <> "") Then
                        If Val(Application.Worksheets("Registration").Range("month").Value) = 0 Then
                            Select Case MonDiff(sel_arr(i, colT1), sel_arr(i, colT2))
                                Case 0
                                    If Month(sel_arr(i, colT1)) = mon And Year(sel_arr(i, colT1)) = Val(yea) Then
                                        setUncl = "" 'дата початку і кінця в одному місяці
                                    Else
                                        setUncl = 2 'послуга в реєстр іншого місяця
                                    End If
                                Case 1
                                    If Month(sel_arr(i, colT1)) = mon And Year(sel_arr(i, colT1)) = Val(yea) Then
                                        setUncl = ""
                                    Else
                                        setUncl = 2 'послуга в реєстр іншого місяця
                                    End If
                                Case Else
                                    setUncl = 3 'різниця місяця початку і кінця більше місяця
                            End Select
                         Else
                            numkv1 = (Val(Month(sel_arr(i, colT1))) + 2) \ 3
                            numkv2 = (Val(Month(sel_arr(i, colT2))) + 2) \ 3
                            If numkv1 = numkv2 And Year(sel_arr(i, colT1)) = Val(yea) And Val(Application.Worksheets("Registration").Range("month")) = numkv1 Then
                                setUncl = ""
                            ElseIf ((numkv1 = numkv2 - 1) Or (numkv2 = numkv1 + 3) Or (numkv1 = numkv2 + 3)) And (Year(sel_arr(i, colT1)) = Val(yea) Or Year(sel_arr(i, colT1)) = Val(yea) - 1) Then  'сусідні квартали
                                Select Case MonDiff(sel_arr(i, colT1), sel_arr(i, colT2))
                                    Case 0
                                        setUncl = 4
                                    Case 1
                                        If Val(Application.Worksheets("Registration").Range("month")) = numkv1 Then
                                            setUncl = ""
                                        ElseIf Val(Application.Worksheets("Registration").Range("month")) = numkv2 Then
                                            setUncl = 3 ' в реєстр попереднього кварталу
                                        Else
                                            setUncl = 4
                                        End If
                                    Case Else
                                        If Val(Application.Worksheets("Registration").Range("month")) = numkv2 And Year(sel_arr(i, colT2)) = Val(yea) Then
                                            setUncl = ""
                                        ElseIf MonDiff(sel_arr(i, colT1), sel_arr(i, colT2)) < 7 Then
                                            setUncl = 2 ' в реєстр наступного кварталу
                                        Else
                                            setUncl = 4
                                        End If
                                End Select
                            Else
                                setUncl = 4 'зовсім різні квартали
                            End If
                         End If
                    Else:
                        If IsDate(sel_arr(i, colT1)) And sel_arr(i, colKodServ) <> "" Then
                            setUncl = 1 'незавершені
                        Else
                            setUncl = ""
                        End If
                    End If
                End If
            Else
                setUncl = ""
            End If
            If Val(Application.Worksheets("Registration").Range("month").Value) = 0 Then
                If setUncl = 2 Then
                    cYearB = Year(sel_arr(i, colT1))
                    cError = "Послуга має бути перенесена в реєстр " & Month(sel_arr(i, colT1)) & "-го місяця " & cYearB & " року"
                    erri = 1
                    GoTo zzz
                End If
                If setUncl = 3 Then
                    cYearB = Year(sel_arr(i, colT1))
                    cYearE = Year(sel_arr(i, colT2))
    '                For iii = 1 To UBound(arrm)
                        If (cYearE <> Val(yea) Or Month(sel_arr(i, colT2)) <> mon) Then  'And (cYearB <> Val(yea) Or Month(sel_arr(i, colT1)) <> mon))
                            cError = "Послуга має бути перенесена в реєстр " & Month(sel_arr(i, colT2)) & "-го місяця " & cYearE & " року"
                            erri = 1
                            GoTo zzz
                        End If
    '                Next iii
                End If
            Else
                If setUncl = 2 Then
'                    cYearB = Year(sel_arr(i, colT1))
                    cError = "Послуга має бути перенесена в реєстр наступного кварталу"
                    erri = 1
                    GoTo zzz
                ElseIf setUncl = 3 Then
                    cError = "Послуга має бути перенесена в реєстр попереднього кварталу"
                    erri = 1
                    GoTo zzz
                ElseIf setUncl = 4 Then
                    cYearE = Year(sel_arr(i, colT2))
                    cError = "Послуга має бути перенесена в реєстр " & numkv2 & "-го кварталу " & cYearE & " року"
                    erri = 1
                    GoTo zzz
                End If
            End If


            If (sel_arr(i, columnSer("Zk")) <> "" Or sel_arr(i, columnSer("Zr")) <> "") And sel_arr(i, columnSer("ReasZ")) = "" Then
                cError = "Не вказано причину затримки"
                erri = 1
                GoTo zzz
            End If
            If sel_arr(i, colErr) = "" Then
            
                Set dicTermsRPSrob = CreateObject("Scripting.Dictionary")
                Set dicTermsRPSkal = CreateObject("Scripting.Dictionary")
                terms = Application.Worksheets("Data").Range("Terms").Value
                For ii = LBound(terms) To UBound(terms)
            '        dicKods.Add terms(i, 1), Val(terms(i, 2))
                    If InStr(1, terms(ii, 3), "роб") <> 0 Then
                        dicTermsRPSrob.Add terms(ii, 1), Val(terms(ii, 3))
                    ElseIf terms(ii, 3) <> "" Then
                        If terms(ii, 3) = "місяць" Then terms(ii, 3) = 30
                        dicTermsRPSkal.Add terms(ii, 1), Val(terms(ii, 3))
                    End If
                Next ii
                If sel_arr(i, columnSer("Skod")) <> "" Then
                    If dicTermsRPSkal.exists(sel_arr(i, colKodServ)) Then
                        If dicTermsRPSkal(sel_arr(i, columnSer("Skod"))) < Val(sel_arr(i, columnSer("Dk"))) Then
                            erri = 2
                            GoTo zzz
                        End If
                    ElseIf dicTermsRPSrob.exists(sel_arr(i, colKodServ)) Then
                        If dicTermsRPSrob(sel_arr(i, columnSer("Skod"))) < Val(sel_arr(i, columnSer("Dr"))) Then
                            erri = 2
                            GoTo zzz
                        End If
                    End If
                End If
            End If
zzz:
    If erri = 1 Then
        Err.Cells(interr, 2) = fileName
        Err.Cells(interr, 3) = Application.Worksheets("Registration").Range("month").Value
        Err.Cells(interr, 4) = i + 14
        Err.Cells(interr, 5) = cError
        interr = interr + 1
    End If

'     If Len(sel_arr(i, cError)) > 900 Then sel_arr(i, cError) = Left(sel_arr(i, cError), 900) & "..."
End Sub

Function MonDiff(ByVal monbeg As Date, ByVal monend As Date)
    MonDiff = DateDiff("m", monbeg, monend)
    If DateDiff("d", monbeg, monend) < 0 Then MonDiff = 0
End Function


Public Sub FirstHolidays(dicHolidays, yea)
    Dim ndays As Integer
    ofholidays = Data.Range("holidays").Value
    For i = 1 To 9
        ofholidays(i, 1) = ofholidays(i, 1) & yea
        dicHolidays.Add CDate(ofholidays(i, 1)), Month(ofholidays(i, 1))
    Next i
    For i = 10 To UBound(ofholidays)
        If Year(ofholidays(i, 1)) = yea Then dicHolidays.Add CDate(ofholidays(i, 1)), Month(ofholidays(i, 1))
    Next i
    ofholidays = dicHolidays.keys
    For i = LBound(ofholidays) To UBound(ofholidays)
        If Weekday(ofholidays(i), vbMonday) = 6 Or Weekday(ofholidays(i), vbMonday) = 7 Then
            ii = IIf(Weekday(ofholidays(i), vbMonday) = 6, 2, 1)
            Do While dicHolidays.exists(DateAdd("y", ii, ofholidays(i))) = True
                ii = ii + 1
            Loop

            ndata = DateAdd("y", ii, ofholidays(i))
            dicHolidays.Add ndata, Month(ndata)
        End If
    Next i

    If InStr((yea / 4), ",") Then ndays = 365 Else ndays = 366
     For i = 1 To ndays
        ndata = DateAdd("y", i - 1, "01.01." & yea)
        If dicHolidays.exists(ndata) = False Then
            If Weekday(ndata, vbMonday) = 6 Or Weekday(ndata, vbMonday) = 7 Then dicHolidays.Add ndata, Month(ndata)
        End If
    Next i
End Sub

Function WorkDateDiff(DBegin, DEnd, yea)
    Nnnn = 0
    tmp_arr = holidays.keys
    For i = 0 To UBound(tmp_arr)
        If (DBegin <= CDate(tmp_arr(i))) And (CDate(tmp_arr(i)) <= DEnd) Then Nnnn = Nnnn + 1
    Next i
    If Year(DBegin) <> Year(DEnd) Then
        If Year(DBegin) = Val(yea) - 1 Then
            tmp_arr = holidaysP.keys
            For i = 0 To UBound(tmp_arr)
                If (DBegin <= CDate(tmp_arr(i))) And (CDate(tmp_arr(i)) <= DEnd) Then Nnnn = Nnnn + 1
            Next i
        End If
        If Year(DEnd) = Val(yea) + 1 Then
            tmp_arr = holidaysN.keys
            For i = 0 To UBound(tmp_arr)
                If (DBegin <= CDate(tmp_arr(i))) And (CDate(tmp_arr(i)) <= DEnd) Then Nnnn = Nnnn + 1
            Next i
        End If
    End If
    WorkDateDiff = DateDiff("d", DBegin, DEnd) - Nnnn
End Function

Sub PRTopen(fileName)

    If Application.Worksheets("Registration").Range("T9") <> "Примітки" Then
        Load.Cells(introw, 9) = "Файл не було завантажено. Невірна форма"
        Load.Cells(introw, 10) = "ПОМИЛКА!"
         End If
    Load.Cells(introw, 6) = Application.Worksheets("Registration").Range("I7").Value
    Load.Cells(introw, 8) = Application.Worksheets("Registration").Range("F7").Value
    Load.Cells(introw, 6) = Application.Worksheets("Registration").Range("month").Value
    Load.Cells(introw, 10) = "OK"
    Load.Cells(introw, 11) = Application.Worksheets("Registration").Range("Q1").Value
    
    Prt.Range("B" & introwprt).Value = fileName
    Prt.Range("I" & introwprt).Value = Val(Application.Worksheets("Registration").Range("U14").Value)
    Prt.Range("C" & introwprt).Value = Val(Application.Worksheets("Registration").Range("E14").Value)
    Prt.Range("F" & introwprt).Value = Val(Application.Worksheets("Registration").Range("F14").Value)
    Prt.Range("D" & introwprt).Value = Val(Application.Worksheets("Registration").Range("R14").Value)
    Prt.Range("G" & introwprt).Value = Val(Application.Worksheets("Registration").Range("R14").Value)
    Prt.Range("E" & introwprt).Value = Val(Application.Worksheets("Registration").Range("S14").Value)
    Prt.Range("H" & introwprt).Value = Val(Application.Worksheets("Registration").Range("S14").Value)
   ' End If
   ' If Prt.Range("I" & introwprt).Value > 0 Then
    'Prt.Range("C" & introwprt).Value = 0
   ' Prt.Range("F" & introwprt).Value = 0
   ' Prt.Range("D" & introwprt).Value = 0
    'Prt.Range("E" & introwprt).Value = 0
   ' Prt.Range("G" & introwprt).Value = 0
   ' Prt.Range("H" & introwprt).Value = 0
      ' Load.Cells(introw, 9) = "Не враховано " & numerr & " перевірок"
       ' Err.Cells(interr, 2) = fileName
       ' Err.Cells(interr, 3) = Application.Worksheets("Registration").Range("month").Value
       ' Err.Cells(interr, 4) = i + 14
       ' Err.Cells(interr, 5) = "Не вказана дата проведення перевірки"
       ' interr = interr + 1
       
        'Else
       ' If Prt.Range("I" & introwprt).Value = 0 Then
  '  End If
    
End Sub

