from django.shortcuts import render, redirect
from django.views.generic import TemplateView, ListView, CreateView
from django.core.files.storage import FileSystemStorage
from subprocess import run, PIPE
import sys


from .models import Results
from .models import Details


class Home(TemplateView):
    template_name = 'home.html'


def upload(request):
    context = {}

    if request.method == 'POST':
        uploaded_file = request.FILES['document'] if 'document' in request.FILES else False
        fs = FileSystemStorage()
        if uploaded_file is False:
            return render(request, 'upload.html')
        if uploaded_file.name.endswith('.exe') or uploaded_file.name.endswith('.pdf') or uploaded_file.name.endswith('zip'):
            return render(request, 'upload.html')
        name = fs.save(uploaded_file.name, uploaded_file)
        context['url'] = name
    return render(request, 'upload.html', context)


def script(request):

    run([sys.executable, '/Users/mac/PycharmProjects/djangosuite/main.py'], shell=False, stdout=PIPE)

    result = Results.objects.all().last()
    det = Details.objects.all()

    return render(request, 'results.html', {'result_list': result, 'details': det})

# print(out.stdout)
# kek = bytes.decode(out.stdout, 'utf-8').split('|')[0]
# kek = bytes.decode(out.stdout, 'utf-8')
# def doprezalt(request):
#     det = Details.objects.all()
#     return render(request, 'results.html', {'details': det})

